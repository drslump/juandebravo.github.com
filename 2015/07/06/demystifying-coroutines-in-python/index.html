<!doctype html>
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Demystifying coroutines in python - juandebravo's personal blog</title>
  <meta name="description" content="juandebravo's personal blog - Personal thoughts about technology (@juandebravo)">
  <meta name="author" content="Juan de Bravo">
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="http://feeds.feedburner.com/juandebravo" rel="alternate" title="juandebravo's personal blog" type="application/atom+xml">
  <link rel="author" href="/humans.txt">

  <link rel="stylesheet" href="/css/emoji.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="stylesheet" href="/css/disqus.css">

  <script src="/js/libs/modernizr-2.0.6.min.js"></script>
</head>

<body>
  <div class='main_container'>
    <div class="title">
      <h1>
        <a href="/index.html">juandebravo's personal blog</a>
      </h1>
    </div>
    <div class="menu">
      <ul>
  
    
    
      
    
    <li class="item active">
      <a href="/index.html">Dev Blog</a>
    </li>
  
    
    
    <li class="item ">
      <a href="/open_source.html">Open Source</a>
    </li>
  
    
    
    <li class="item ">
      <a href="/about_me.html">About me</a>
    </li>
  
</ul>
    </div>
    <div class="container">

      <header>   
  <h2><a class="fadedlink" href="/" title="Home">&laquo;</a> Demystifying coroutines in python <small>06 Jul 2015</small></h2>

  <nav>
    <ul class="clearfix">
    
      <li><a href="/tag/python.html">python</a></li>
    
    </ul>
  </nav>
</header>

<div id="post" role="main">
  <p><a href="http://en.wikipedia.org/wiki/Coroutine">Coroutines</a> are <em>special functions</em> that differs from <em>usual ones</em> in four aspects:</p>

<ul>
<li><strong>exposes several entry points to a function</strong>. An entry point is the line of code inside the function where it will take control over the execution.</li>
<li><strong>can receive a different input</strong> in every entry point while executing the coroutine.</li>
<li>can <strong>return different outputs</strong> as response to the different entry points.</li>
<li>can <strong>save control state</strong> between entry points calls.</li>
</ul>

<p><strong>Python implements coroutines starting in <em>Python 2.5</em> by reusing the generator syntax</strong>, as defined in <a href="https://www.python.org/dev/peps/pep-0342/">PEP 342 - Coroutines via Enhanced Generators</a>.</p>

<p>Generator syntax is defined in <a href="https://www.python.org/dev/peps/pep-0255/">PEP 255 - Simple generators</a>. I covered briefly the generator functionality in a <a href="/2012/07/16/why-python-rocks/">previous post</a>. The basic usage of generators is creating an iterator over a data source. For example, the function in the snippet below returns a generator that iterates from a specific number till 0, decreasing an unit in every iteration.</p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">countdown</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Counting down from </span><span class="si">%s</span><span class="s"> to 0&quot;</span> <span class="o">%</span> <span class="n">n</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">i</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre>
</div>

<div class="highlight"><pre><code class="bash">&gt;&gt;&gt; <span class="k">for </span>i in countdown<span class="o">(</span>5<span class="o">)</span>:
&gt;&gt;&gt;     print i
...
Counting down from 5 to 0
5
4
3
2
1
0
</code></pre>
</div>

<p>In the example above, the keyword <strong>yield</strong> is used to return a new value in every iteration while consuming the generator. It's interesting to note that a generator can be consumed only once, oposite to a list that can be consumed/iterate as much as needed. A generator is considered <em>exhausted</em> after being consumed.</p>

<p><strong>PEP 342</strong> takes advantage of the keyword <strong>yield</strong> for pointing out entry points where the function/coroutine will receive inputs while being executed. Let's see a very simple example of a coroutine that
concatenates every string inserted by the user from the command line:</p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="n">_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coroutine that receives a new string in every</span>
<span class="sd">    iteration and concatenates to the original one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">while</span> <span class="n">temp</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="c"># Wait for a new input (suspend the coroutine)...</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="k">yield</span>
        <span class="c"># ... and save control state (resume the execution)</span>
        <span class="n">_str</span> <span class="o">+=</span> <span class="n">temp</span>
        <span class="k">print</span> <span class="n">_str</span>

<span class="c"># Instantiate a new coroutine...</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>

<span class="c"># ... and &quot;move&quot; the coroutine state till the `yield` keyword</span>
<span class="n">a</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Send the raw input from the user to the coroutine...</span>
        <span class="n">a</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">raw_input</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="c"># ... and capture the coroutine end by means</span>
        <span class="c"># of StopIteration exception</span>
        <span class="k">break</span>
</code></pre>
</div>

<p>What is really interesting is how the coroutine execution is suspended and resumed by means of the
<strong>yield</strong> keyword, allowing the program flow to be moved from the coroutine to the external program
and back to it.</p>

<div class="highlight"><pre><code class="bash">python coroutine.py
bar
    foobar
bazz
    foobarbazz

    foobarbazz
</code></pre>
</div>

<p>May you be interested in additional information about this topic, I recommend going through <a href="http://www.dabeaz.com/">Daviz Beazley</a> slides regarding <a href="http://www.dabeaz.com/generators/Generators.pdf">generators</a> and <a href="http://www.dabeaz.com/coroutines/Coroutines.pdf">coroutines</a>.</p>

<p>As a side project I have implemented a tiny library called <em><a href="https://github.com/juandebravo/washington">washington</a></em> that exposes a chainable API for building a coroutines stream.</p>

  
  <p class="back">&laquo; <a href="/">Home</a></p>
</div>
      
<!--h2>Related Posts</h2>
<ul class="posts_list">
  
    <li class="post">
  <span class="left_title">10 Apr 2015</span>
  <a href="/2015/04/10/java-yyyy-date-format" title="Don't use YYYY in your date format template">Don't use YYYY in your date format template</a>
</li>
  
    <li class="post">
  <span class="left_title">15 Feb 2015</span>
  <a href="/2015/02/15/toggle-func-in-python" title="Hanoi. Toggle functionalities in python">Hanoi. Toggle functionalities in python</a>
</li>
  
    <li class="post">
  <span class="left_title">23 Jan 2015</span>
  <a href="/2015/01/23/validate-arity" title="Validating Arity in JavaScript">Validating Arity in JavaScript</a>
</li>
  
</ul-->

<hr/>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'juandebravo'; // required: replace example with your forum shortname
    //var disqus_developer = 1; // developer mode is on, for testing locally

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


      <footer>
        <span class="author_info">
          <a href="/about_me.html">Juan de Bravo</a>
        </span>
        <a class="fadedlink footer_link github" href="https://github.com/juandebravo">
          @github
        </a>
        <a class="fadedlink footer_link twitter" href="https://twitter.com/juandebravo">
          @twitter
        </a>
        <a class="fadedlink footer_link linkedin" href="http://linkedin.com/in/juandebravo">
          @linkedin
        </a>
        <a class="fadedlink" href="mailto:juandebravo@gmail.com">
          <img src="/gfx/gmail-logo.png" alt="@gmail">
        </a>
      </footer>
    </div>
  </div>

  <script>
    window._gaq = [['_setAccount','UA-32824811-1'],['_trackPageview'],['_trackPageLoadTime']];
    Modernizr.load({
      load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
    });
  </script>

  <!--[if lt IE 7 ]>
    <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
    <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->
</body>
</html>
